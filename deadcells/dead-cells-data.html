<!DOCTYPE html>

<html lang="en">
<head>
  <!-- The jQuery library is a prerequisite for all jqSuite products -->
  <script type="text/ecmascript" src="https://code.jquery.com/jquery-3.2.1.min.js"></script>

  <!-- This is the Javascript file of jqGrid -->
  <script type="text/ecmascript" src="js/jquery.jqGrid.js"></script>

  <!-- This is the localization file of the grid controlling messages, labels, etc. -->
  <!-- We support more than 40 localizations -->
  <script type="text/ecmascript" src="js/grid.locale-en.js"></script>

  <!-- A link to a jQuery UI ThemeRoller theme, more than 22 built-in and many more custom -->
  <link rel="stylesheet" type="text/css" media="screen" href="css/jquery-ui.css"/>

  <!-- The link to the CSS that the grid needs -->
  <link rel="stylesheet" type="text/css" media="screen" href="css/ui.jqgrid.css"/>

  <meta charset="utf-8"/>
  <title>Dead Cells Data</title>

  <style type="text/css">
    /*内容过长自动换行*/
    .ui-jqgrid tr.jqgrow td {
      white-space: normal !important;
    }

    /*@formatter:off*/
        /*适合像素图片的设置*/
        .icon {
            image-rendering: optimizeSpeed; /* Older versions of FF          */
            image-rendering: -moz-crisp-edges; /* FF 6.0+                       */
            image-rendering: -webkit-optimize-contrast; /* Safari                        */
            image-rendering: -o-crisp-edges; /* OS X & Windows Opera (12.02+) */
            image-rendering: pixelated; /* Awesome future-browsers       */
            -ms-interpolation-mode: nearest-neighbor; /* IE                            */
        }

        /*@formatter:on*/

    #cardIcons {
      display: none;
    }
  </style>
</head>
<body>
<h1>Dead Cells Cheat Sheet</h1>
<span>version: 2017-06-02 (e2c7b364)</span>
<table id="jqGridTemp"></table>
<div id="jqGridPagerTemp"></div>
<br/>
<table id="jqGridItem"></table>
<div id="jqGridPagerItem"></div>
<br/>
<table id="jqGridMob"></table>
<div id="jqGridPagerMob"></div>
<br/>
<table id="jqGridLevel"></table>
<div id="jqGridPagerLevel"></div>
<br/>
<table id="jqGridAffix"></table>
<div id="jqGridPagerAffix"></div>
<img id="cardIcons" src="resource/cardIcons.png"/>
<script type="text/ecmascript">
    // 语言参数，通过 url 传入，默认英文
    var lang = getParameterByName('lang') || "en";

    // 充当 Loading 界面
    $("#jqGridTemp").jqGrid({
        datatype: 'json',
        url: 'resource/data_min.cdb',
        jsonReader: {root: "sheets[1].lines"},
        cmTemplate: {
            width: 65
        },
        colModel: [
            {name: 'icon', align: 'center'},
            {name: 'name'},
            {name: 'gameplayDesc', width: 200},
            {name: 'blueprint', width: 200},
            {name: 'cellCost', align: 'right'},
            {name: 'moneyCost', align: 'right'},
            {name: 'droppable', align: 'center'},
            {name: 'hasLevels', align: 'center'},
            {name: 'hasTier', align: 'center'},
            {name: 'castCD', align: 'right'},
            {name: 'tags', width: 100}
        ],
        caption: 'Item',
        viewrecords: true,
        height: 600,
        width: 1280,
        rownumbers: true,
        rowNum: 9999,
        pager: "#jqGridPagerTemp"
    });

    $(window).on("load", function () {
        $.getJSON("resource/data_min.cdb", function (jsonData) {
            var jsonItems = jsonData.sheets[1].lines;
            var jsonMobs = jsonData.sheets[2].lines;
            var jsonLevels = jsonData.sheets[12].lines;
            var jsonAffixs = jsonData.sheets[10].lines;
            var jsonTags = jsonData.sheets[11].lines;
            var jsonChances = jsonData.sheets[42].lines;

            var MobFormatter = {
                genTags: function (cellValue, options, rowObject) {
                    return jsonTags[cellValue].id;
                }
            };

            var AffixFormatter = {
                forbiddenAffixes: function (cellValue, options, rowObject) {
                    return cellValue.map(function (elem) {
                        return elem.affix;
                    }).join("<br/>");
                },
                forbiddenItem: function (cellValue, options, rowObject) {
                    return cellValue.map(function (elem) {
                        return translate(findItemName(elem.item));
                    }).join("<br/>");
                }
            };

            // 隐藏 Loading 界面
            document.body.removeChild(document.querySelector("#gbox_jqGridTemp"));

            // 去除无用数据和排序
            jsonLevels = jsonLevels.filter(function (level) {
                return level.name && !/debug/i.test(level.name) && level.biome !== 'SecretRooms'
            }).sort(function (first, second) {
                if (first.mobTier - second.mobTier === 0) {
                    return first.lootLevel - second.lootLevel;
                } else {
                    return first.mobTier - second.mobTier;
                }
            });

            // 道具表格
            $("#jqGridItem").jqGrid({
                datatype: 'local',
                data: jsonItems,
                cmTemplate: {
                    width: 65
                },
                colModel: [
                    {name: 'id', hidden: true},
                    {name: 'icon', formatter: showIcon, align: 'center'},
                    {name: 'name', formatter: translate},
                    {name: 'gameplayDesc', formatter: translateDesc, width: 200},
                    {name: 'blueprint', formatter: findBlueprint, width: 200},
                    {name: 'cellCost', align: 'right'},
                    {name: 'moneyCost', align: 'right'},
                    {name: 'droppable', align: 'center'},
                    {name: 'hasLevels', align: 'center'},
                    {name: 'castCD', align: 'center'},
                    {name: 'tags', formatter: formatTags, width: 100}
                ],
                caption: 'Item',
                viewrecords: true,
                height: 600,
                width: 1200,
                rownumbers: true,
                rowNum: 9999,
                pager: "#jqGridPagerItem"
            });


            // 怪物表格
            $("#jqGridMob").jqGrid({
                datatype: 'local',
                data: jsonMobs,
                cmTemplate: {
                    width: 65
                },
                colModel: [
                    {name: 'icon', formatter: showIcon, align: 'center', hidden: true},
                    {name: 'name', formatter: translate},
                    {name: 'life', align: 'right'},
                    {name: 'canBeElite', align: 'center'},
                    {name: 'cells', formatter: formatCells, width: 120, hidden: true},
                    {name: 'blueprints', formatter: formatBlueprints, width: 200},
                    {name: 'genTags', formatter: MobFormatter.genTags, hidden: true},
                    {name: 'level', formatter: findLevel, width: 200}
                ],
                caption: 'Monster',
                viewrecords: true,
                height: 600,
                width: 1200,
                rownumbers: true,
                rowNum: 9999,
                pager: "#jqGridPagerMob"
            });

            // 关卡表格
            $("#jqGridLevel").jqGrid({
                datatype: 'local',
                data: jsonLevels,
                cmTemplate: {
                    width: 65
                },
                colModel: [
                    {name: 'name', formatter: formatLevelName, width: 80},
                    {name: 'mobTier', align: 'center'},
                    {name: 'lootLevel', align: 'center'},
                    {name: 'eliteWanderChance', formatter: formatChance, align: 'center'},
                    {name: 'eliteRoomChance', formatter: formatChance, align: 'center'},
                    {name: 'mobs', formatter: formatMobs}
                ],
                caption: 'Level',
                viewrecords: true,
                height: 600,
                width: 1200,
                rownumbers: true,
                rowNum: 9999,
                pager: "#jqGridPagerLevel"
            });


            // 词缀表格
            $("#jqGridAffix").jqGrid({
                datatype: 'local',
                data: jsonAffixs,
                cmTemplate: {
                    width: 65
                },
                colModel: [
                    {name: 'id'},
                    {name: 'desc', formatter: formatAffixDesc, width: 200},
                    {name: 'chance', formatter: formatAffixChance, hidden: false},
                    {name: 'itemRestriction', hidden: false},
                    {name: 'requiredTags', formatter: formatTags},
                    {name: 'forbiddenTags', formatter: formatTags},
                    {name: 'forbiddenAffixes', formatter: AffixFormatter.forbiddenAffixes},
                    {name: 'forbiddenItem', formatter: AffixFormatter.forbiddenItem}
                ],
                caption: 'Affix',
                viewrecords: true,
                height: 600,
                width: 1200,
                rownumbers: true,
                rowNum: 9999,
                pager: "#jqGridPagerAffix"
            });

            function showIcon(cellValue, options, rowObject) {
                var cardIconsImage = document.querySelector("#cardIcons");
                var size = cellValue.size;
                var displaySize = size * 2;

                var canvas = $('<canvas width="' + size + '" height="' + size + '"></canvas>')[0],
                    ctx = canvas.getContext('2d');
                ctx.drawImage(cardIconsImage, cellValue.x * size, cellValue.y * size, size, size, 0, 0, size, size);
                return '<img style="width:' + displaySize + 'px;" class="icon" src="' + canvas.toDataURL() + '"/>';
            }

            var langContentEng;
            var langContentZh;

            // 读取英文中文文本
            function translate(text) {
                function loadLang(lang) {
                    var result = {};
                    jQuery.ajax({
                        url: 'resource/lang/main.' + lang + '.po',
                        success: function (resultText) {
                            var langs = resultText.split(/\n\n/).slice(1);
                            langs.forEach(function (lang) {
                                var key;
                                var keyMatchSingleLine = lang.match(/^msgid "(.+)"$/m);
                                var keyMatchMultiLine = lang.match(/^msgid ""\n([\s\S]+)\nmsgstr/);
                                if (keyMatchSingleLine) {
                                    key = keyMatchSingleLine[1];
                                } else if (keyMatchMultiLine) {
                                    key = keyMatchMultiLine[1].replace(/^"|"$|\n/mg, "");
                                }

                                var value;
                                var valueMatchSingleLine = lang.match(/^msgstr "(.+)"$/m);
                                var valueMatchMultiLine = lang.match(/msgstr ""\n([\s\S]+)/);
                                if (valueMatchSingleLine) {
                                    value = valueMatchSingleLine[1];
                                } else if (valueMatchMultiLine) {
                                    value = valueMatchMultiLine[1].replace(/^"|"$|\n/mg, "");
                                }

                                if (key && value) {
                                    key.replace(/\\"/g, '"');
                                    value.replace(/\\"/g, '"');
                                    result[key] = value;
                                }
                            });
                        },
                        async: false
                    });
                    return result;
                }

                if (!text) {
                    return "";
                }

                if (!langContentEng) {
                    langContentEng = loadLang('en');
                }

                if (!langContentZh && lang === 'zh') {
                    langContentZh = loadLang('zh');
                }

                if (lang === 'en') {
                    return langContentEng[text] || text;
                } else if (lang === 'zh') {
                    var translatedEn = langContentEng[text];
                    var translatedZh = langContentZh[text];

                    if (translatedZh) {
                        return translatedZh;
                    } else if (translatedEn) {
                        return langContentZh[translatedEn] || translatedEn;
                    }

                    return text;
                }
            }

            function replaceProps(translateStr, rowObject, isFloat) {
                isFloat = isFloat || true;
                translateStr = translateStr.replace(/\*([^*]+)\*/g, '<b>$1</b>');

                var matchResult = translateStr.match(/::.+?::/g);
                if (!matchResult) {
                    return translateStr;
                }

                matchResult.forEach(function (prop) {
                    var propName = prop.replace(/::[^a-z]?(.+)::/g, '$1');
                    if (propName === 'prct' && rowObject.props[propName] > 0) {
                        if (isFloat) {
                            rowObject.props[propName] *= 100;
                        }
                    }
                    translateStr = translateStr.replace(prop, rowObject.props[propName] || '???');
                });

                return translateStr;
            }

            function translateDesc(cellValue, options, rowObject) {
                return replaceProps(translate(cellValue), rowObject) + translate(rowObject.ambiantDesc);
            }

            function formatTags(cellValue) {
                return cellValue.map(function (elem) {
                    return elem.tag;
                }).join("<br/>");
            }

            function findItemName(itemId) {
                var items = jsonItems.filter(function (item) {
                    return item.id === itemId;
                });

                if (items && items.length > 0) {
                    return items[0].name;
                } else {
                    return itemId;
                }
            }

            function findMobName(mobId) {
                var mobs = jsonMobs.filter(function (mob) {
                    return mob.id === mobId;
                });

                if (mobs && mobs.length > 0) {
                    return mobs[0].name;
                } else {
                    return mobId;
                }
            }

            function formatBlueprints(cellValue) {
                return cellValue.map(function (blueprint) {
                    return translate(findItemName(blueprint.item)) + ': ' + formatChance(findBlueprintChance(blueprint.rarity));
                }).join("<br/>");
            }

            function formatCells(cellValue, options, rowObject) {
                if (!cellValue || !rowObject.cellChance) {
                    return "";
                }
                return cellValue + " cell " + rowObject.cellChance * 100 + "% chance";
            }

            function formatMobs(cellValue, options, rowObject) {
                return cellValue.map(function (elem) {
                    return translate(findMobName(elem.mob));
                }).join("<br/>");
            }

            function findBlueprint(cellValue, options, rowObject) {
                var result = jsonMobs.filter(function (monster) {
                    return monster.blueprints.some(function (blueprint) {
                        if (blueprint.item === rowObject.id) {
                            monster.blueprintChance = formatChance(findBlueprintChance(blueprint.rarity));
                        }
                        return blueprint.item === rowObject.id;
                    })
                }).map(function (monster) {
                    return translate(monster.name) + ': ' + monster.blueprintChance;
                });

                return result.join("<br/>");
            }

            // 根据单词查询具体概率
            function findBlueprintChance(rarity) {
                var result = jsonChances.filter(function (blueprintDrop) {
                    return blueprintDrop.id === rarity;
                });
                if (result.length > 0) {
                    return result[0].chance;
                }
            }

            function formatLevelName(cellValue, options, rowObject) {
                return translate(cellValue);
            }

            function formatChance(chance) {
                return (chance * 100).toFixed(2) * 100 / 100 + "%";
            }

            function formatAffixChance(chance) {
                return chance + "%";
            }

            function formatAffixDesc(cellValue, options, rowObject) {
                return replaceProps(translate(cellValue), rowObject, true);
            }

            function findLevel(cellValue, options, rowObject) {
                var result = jsonLevels.filter(function (level) {
                    return level.mobs.some(function (mob) {
                        return mob.mob === rowObject.id;
                    })
                }).sort(function (first, second) {
                    return first.lootLevel - second.lootLevel;
                })
                    .map(function (level) {
                        return translate(level.name);
                    });

                return result.join("<br/>");
            }
        });
    });

    function getParameterByName(name, url) {
        if (!url) url = window.location.href;
        name = name.replace(/[\[\]]/g, "\\$&");
        var regex = new RegExp("[?&]" + name + "(=([^&#]*)|&|#|$)"),
            results = regex.exec(url);
        if (!results) return null;
        if (!results[2]) return '';
        return decodeURIComponent(results[2].replace(/\+/g, " "));
    }
</script>
</body>
</html>