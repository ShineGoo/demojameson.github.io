<!DOCTYPE html>

<html lang="en">
<head>
    <!-- The jQuery library is a prerequisite for all jqSuite products -->
    <script type="text/ecmascript" src="https://code.jquery.com/jquery-3.2.1.min.js"></script>

    <!-- This is the Javascript file of jqGrid -->
    <script type="text/ecmascript" src="js/jquery.jqGrid.js"></script>

    <!-- This is the localization file of the grid controlling messages, labels, etc. -->
    <!-- We support more than 40 localizations -->
    <script type="text/ecmascript" src="js/grid.locale-en.js"></script>

    <!-- A link to a jQuery UI ThemeRoller theme, more than 22 built-in and many more custom -->
    <link rel="stylesheet" type="text/css" media="screen" href="css/jquery-ui.css"/>

    <!-- The link to the CSS that the grid needs -->
    <link rel="stylesheet" type="text/css" media="screen" href="css/ui.jqgrid.css"/>

    <meta charset="utf-8"/>
    <title>Dead Cells Data</title>

    <style type="text/css">
        /*内容过长自动换行*/
        .ui-jqgrid tr.jqgrow td {
            white-space: normal !important;
        }

        /*@formatter:off*/
        /*适合像素图片的设置*/
        .icon {
            image-rendering: optimizeSpeed; /* Older versions of FF          */
            image-rendering: -moz-crisp-edges; /* FF 6.0+                       */
            image-rendering: -webkit-optimize-contrast; /* Safari                        */
            image-rendering: -o-crisp-edges; /* OS X & Windows Opera (12.02+) */
            image-rendering: pixelated; /* Awesome future-browsers       */
            -ms-interpolation-mode: nearest-neighbor; /* IE                            */
        }

        /*@formatter:on*/

        #cardIcons {
            display: none;
        }
    </style>
</head>
<body>
<h1>Dead Cells Cheat Sheet</h1>
<table id="jqGridItem"></table>
<div id="jqGridPagerItem"></div>
<br/>
<table id="jqGridMob"></table>
<div id="jqGridPagerMob"></div>
<br/>
<table id="jqGridLevel"></table>
<div id="jqGridPagerLevel"></div>
<img id="cardIcons" src="resource/cardIcons.png"/>
<script type="text/ecmascript">
    $(document).ready(function () {
        var jsonData;
        $.getJSON("resource/data.cdb", function (result) {
            jsonData = result;

            // 去除无用数据
            jsonData.sheets[12].lines = jsonData.sheets[12].lines.filter(function (level) {
                return level.name && !/debug/i.test(level.name) && level.biome !== 'SecretRooms'
            });

            $("#jqGridItem").jqGrid({
                datatype: 'local',
                data: jsonData.sheets[1].lines,
                cmTemplate: {
                    width: 65
                },
                colModel: [
                    {name: 'icon', formatter: showIcon, align: 'center'},
                    {name: 'name', formatter: translateByMsgid},
                    {name: 'gameplayDesc', formatter: translateDesc, width: 200},
                    {name: 'blueprint', formatter: findBlueprint, width: 200},
                    {name: 'cellCost', align: 'right'},
                    {name: 'moneyCost', align: 'right'},
                    {name: 'droppable', align: 'center'},
                    {name: 'hasLevels', align: 'center'},
                    {name: 'hasTier', align: 'center'},
                    {name: 'castCD', align: 'right'},
                    {name: 'tags', formatter: formatTag, width: 100}
                ],
                caption: 'Item',
                viewrecords: true,
                height: 600,
                width: 1280,
                rownumbers: true,
                rowNum: 9999,
                pager: "#jqGridPagerItem"
            });

            $("#jqGridMob").jqGrid({
                datatype: 'local',
                data: jsonData.sheets[2].lines,
                cmTemplate: {
                    width: 65
                },
                colModel: [
                    {name: 'icon', formatter: showIcon, align: 'center', hidden: true},
                    {name: 'name', formatter: translateByMsgid},
                    {name: 'life', align: 'right'},
                    {name: 'canBeElite', align: 'center'},
                    {name: 'cells', formatter: formatCells, width: 120},
                    {name: 'blueprints', formatter: formatBlueprints, width: 200},
                    {name: 'level', formatter: findLevel, width: 200}
                ],
                caption: 'Monster',
                viewrecords: true,
                height: 600,
                width: 1280,
                rownumbers: true,
                rowNum: 9999,
                pager: "#jqGridPagerMob"
            });

            $("#jqGridLevel").jqGrid({
                datatype: 'local',
                data: jsonData.sheets[12].lines,
                cmTemplate: {
                    width: 65
                },
                colModel: [
                    {name: 'name', formatter: translateByMsgid, width: 80},
                    {name: 'mobTier', align: 'right'},
                    {name: 'lootLevel', align: 'right'},
                    {name: 'eliteWanderChance', formatter: formatChance, align: 'right', width: 120},
                    {name: 'eliteRoomChance', formatter: formatChance, align: 'right', width: 120},
                    {name: 'mobs', formatter: formatMobs}
                ],
                caption: 'Level',
                viewrecords: true,
                height: 600,
                width: 1280,
                rownumbers: true,
                rowNum: 9999,
                pager: "#jqGridPagerLevel"
            });
        });

        function showIcon(cellValue, options, rowObject) {
            var cardIconsImage = document.querySelector("#cardIcons");
            var size = cellValue.size;
            var displaySize = size * 2;

            var canvas = $('<canvas width="' + size + '" height="' + size + '"></canvas>')[0],
                ctx = canvas.getContext('2d');
            ctx.drawImage(cardIconsImage, cellValue.x * size, cellValue.y * size, size, size, 0, 0, size, size);
            return '<img style="width:' + displaySize + 'px;" class="icon" src="' + canvas.toDataURL() + '"/>';
        }

        var langContent;
        var lang = getParameterByName('lang') || "fr";

        function translate(cellValue, options, rowObject, prefix, suffix) {
            prefix = prefix || "";
            suffix = suffix || "";

            if (!langContent) {
                jQuery.ajax({
                    url: 'resource/lang/main.' + lang + '.po',
                    success: function (result) {
                        langContent = result;
                    },
                    async: false
                });
            }

            if (!cellValue) {
                return "";
            }

            if (lang === "fr") {
                return replaceProps(cellValue, rowObject);
            }

            var fromIndex = langContent.indexOf(prefix + cellValue.substr(0, 60) + suffix);
            if (fromIndex < 0) {
                return cellValue;
            }

            var localStrStartFlag = 'msgstr "';
            var localStrIndexStart = langContent.indexOf(localStrStartFlag, fromIndex);
            if (localStrIndexStart < 0) {
                return cellValue;
            }

            localStrIndexStart += localStrStartFlag.length;

            var localStrLength = langContent.indexOf('"', localStrIndexStart) - localStrIndexStart;
            var translateStr = langContent.substr(localStrIndexStart, localStrLength);

            return replaceProps(translateStr, rowObject);
        }

        function replaceProps(translateStr, rowObject) {
            translateStr = translateStr.replace(/\*([^*]+)\*/g, '<b>$1</b>');

            var matchResult = translateStr.match(/::.+?::/g);
            if (!matchResult) {
                return translateStr;
            }

            matchResult.forEach(function (prop) {
                var propName = prop.replace(/::[^a-z]?(.+)::/g, '$1');
                if (propName === 'prct' && rowObject.props[propName] > 0) {
                    rowObject.props[propName] *= 100;
                }
                translateStr = translateStr.replace(prop, rowObject.props[propName] || '???');
            });

            return translateStr;
        }

        function translateDesc(cellValue, options, rowObject) {
            return translate(cellValue, options, rowObject, '', '') + translate(rowObject.ambiantDesc, options, rowObject, '', '');
        }

        function translateByMsgid(cellValue, options, rowObject) {
            return translate(cellValue, options, rowObject, 'msgid "', '"');
        }

        function translateByName(cellValue, options, rowObject) {
            return translate(cellValue, options, rowObject, '#. ', ' (name)');
        }

        function formatTag(cellValue) {
            return cellValue.map(function (elem) {
                return elem.tag;
            }).join("<br/>");
        }

        function formatChance(cellValue) {
            return cellValue * 100 + "%";
        }

        function formatBlueprints(cellValue) {
            return cellValue.map(function (blueprint) {
                return translateByName(blueprint.item) + ': ' + blueprint.chance * 100 + "%";
            }).join("<br/>");
        }

        function formatCells(cellValue, options, rowObject) {
            if (!cellValue || !rowObject.cellChance) {
                return "";
            }
            return cellValue + " cell " + rowObject.cellChance * 100 + "% chance";
        }

        function formatMobs(cellValue, options, rowObject) {
            return cellValue.map(function (elem) {
                return translateByName(elem.mob);
            }).join("<br/>");
        }

        function findBlueprint(cellValue, options, rowObject) {
            var monsters = jsonData.sheets[2].lines;
            var result = monsters.filter(function (monster) {
                return monster.blueprints.some(function (blueprint) {
                    if (blueprint.item === rowObject.id) {
                        monster.blueprintChance = blueprint.chance * 100 + "%";
                    }
                    return blueprint.item === rowObject.id;
                })
            }).map(function (monster) {
                return translateByMsgid(monster.name) + ': ' + monster.blueprintChance;
            });

            return result.join("<br/>");
        }

        function findLevel(cellValue, options, rowObject) {
            var levels = jsonData.sheets[12].lines;
            var result = levels.filter(function (level) {
                return level.mobs.some(function (mob) {
                    return mob.mob === rowObject.id;
                })
            }).sort(function (first, second) {
                return first.lootLevel - second.lootLevel;
            })
                .map(function (level) {
                    return translateByName(level.id);
                });

            return result.join("<br/>");
        }

        function unique(value, index, self) {
            return self.indexOf(value) === index;
        }

        function getParameterByName(name, url) {
            if (!url) url = window.location.href;
            name = name.replace(/[\[\]]/g, "\\$&");
            var regex = new RegExp("[?&]" + name + "(=([^&#]*)|&|#|$)"),
                results = regex.exec(url);
            if (!results) return null;
            if (!results[2]) return '';
            return decodeURIComponent(results[2].replace(/\+/g, " "));
        }
    });
</script>
</body>
</html>